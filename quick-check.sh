#!/bin/bash

clear

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "  ğŸ” DIAGNÃ“STICO RÃPIDO - Â¿Por quÃ© no veo logs?"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Verificar si hay servidor corriendo
echo "â³ Verificando si el servidor estÃ¡ corriendo..."
sleep 1

if lsof -Pi :3000 -sTCP:LISTEN -t >/dev/null 2>&1; then
    PID=$(lsof -Pi :3000 -sTCP:LISTEN -t)
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âœ… SERVIDOR CORRIENDO (PID: $PID)"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "El servidor de Next.js estÃ¡ corriendo en puerto 3000."
    echo ""
    echo "ğŸ“ Los logs del webhook deben aparecer en la terminal"
    echo "   donde ejecutaste 'npm run dev'"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ§ª PROBANDO EL ENDPOINT..."
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Enviando peticiÃ³n de prueba al webhook..."
    echo "(Esto deberÃ­a generar logs en la terminal del servidor)"
    echo ""
    sleep 1
    
    # Hacer peticiÃ³n de prueba
    response=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/webhooks/clerk \
      -H "Content-Type: application/json" \
      -d '{"test": true}' 2>&1)
    
    http_code=$(echo "$response" | tail -n1)
    
    echo "Respuesta del servidor: HTTP $http_code"
    echo ""
    
    if [ "$http_code" == "400" ] || [ "$http_code" == "200" ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Â¡EL ENDPOINT FUNCIONA!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "El webhook se ejecutÃ³ correctamente."
        echo ""
        echo "ğŸ” AHORA MIRA LA TERMINAL DONDE EJECUTASTE 'npm run dev'"
        echo ""
        echo "DeberÃ­as ver lÃ­neas como estas:"
        echo "  ğŸš€ WEBHOOK CLERK - INICIO DE EJECUCIÃ“N"
        echo "  ğŸ“‹ Headers recibidos:"
        echo "  ..."
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“‹ SI VES LOS LOGS:"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "âœ… El cÃ³digo funciona perfectamente"
        echo "âœ… El problema es que Clerk no estÃ¡ enviando eventos"
        echo ""
        echo "ğŸ‘‰ Siguiente paso: Configurar el webhook en Clerk"
        echo "   Lee: DIAGNOSTICO_RESUMEN.md"
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“‹ SI NO VES LOS LOGS:"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "âš ï¸  Puede que estÃ©s viendo la terminal incorrecta"
        echo ""
        echo "Los logs aparecen SOLO en la terminal donde ejecutaste"
        echo "'npm run dev', no en esta terminal."
        echo ""
        echo "Busca la terminal que tiene este mensaje:"
        echo "  âœ“ Ready on http://localhost:3000"
        echo ""
        echo "Esa es donde aparecen los logs del webhook."
        echo ""
    elif [ "$http_code" == "404" ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ ERROR 404 - ENDPOINT NO ENCONTRADO"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "Next.js no encuentra la ruta del webhook."
        echo ""
        echo "ğŸ”§ SOLUCIÃ“N:"
        echo ""
        echo "1. DetÃ©n el servidor (busca la terminal con npm run dev"
        echo "   y presiona Ctrl+C)"
        echo ""
        echo "2. Ejecuta:"
        echo "   rm -rf .next"
        echo "   npm run dev"
        echo ""
        echo "3. Vuelve a ejecutar este script"
        echo ""
    else
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âš ï¸  RESPUESTA INESPERADA: $http_code"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "Hay un problema con el endpoint."
        echo ""
        echo "Revisa la terminal donde corre 'npm run dev'"
        echo "para ver los errores completos."
        echo ""
    fi
    
else
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âŒ NO HAY SERVIDOR CORRIENDO"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Esta es la razÃ³n por la que NO ves los console.log:"
    echo ""
    echo "  âŒ Next.js no estÃ¡ corriendo"
    echo "  âŒ El cÃ³digo del webhook no se ejecuta"
    echo "  âŒ Los logs no pueden aparecer"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ”§ SOLUCIÃ“N:"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "1. Abre una nueva terminal"
    echo ""
    echo "2. Ejecuta estos comandos:"
    echo ""
    echo "   cd $(pwd)"
    echo "   npm run dev"
    echo ""
    echo "3. Espera a ver este mensaje:"
    echo "   âœ“ Ready on http://localhost:3000"
    echo ""
    echo "4. DEJA ESA TERMINAL ABIERTA"
    echo "   (Los logs del webhook aparecerÃ¡n AHÃ)"
    echo ""
    echo "5. Vuelve a ejecutar este script en OTRA terminal:"
    echo "   ./quick-check.sh"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
fi

echo ""
echo "ğŸ“– Para mÃ¡s informaciÃ³n, lee: POR_QUE_NO_VEO_LOGS.md"
echo ""
